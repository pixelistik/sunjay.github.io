---
layout: post
title: Rust Code Coverage with kcov + Travis CI + Codecov / Coveralls
author: sunjay
categories:
  - Programming
---

**Last Updated:** TODO

The de facto [code coverage tutorial for Rust][old-tutorial]{: rel="nofollow" target="_blank"} was published
on March 15, 2015. If you Google "rust code coverage" you will largely find
links to that tutorial. It is a great guide and covers much of what you
need to know to generate code coverage data for your project.

In this post, I will be going into greater depth about Rust code coverage,
how to set it up on your local machine as well as detailed instructions
about integrating it with Travis CI, [Coveralls][coveralls] and [Codecov][codecov].

If you have any questions or comments regarding this article, please use my [Contact][contact] form to get in touch with me.<br />
A faster way to get help is to use the [Rust IRC channels][rust-irc].<br />
This website is [open-source][website-source] so if you find a problem with this article, please open an [Issue][website-issues] and I will address it as quickly as possible.
{: .alert}

I recently [helped][codecov-rust-pr] the [Codecov][codecov] team fully
integrate Rust by writing their [Rust example][codecov-example-rust].
With that, you can now use [Codecov][codecov] without any hesitation of it
not working or not knowing how to integrate it. You can consider this guide a much more detailed version of that example.

I will talk about integrating [Coveralls][coveralls] for anyone using
that service.


Outline:

- contributed to [Codecov][codecov] to integrate Rust code coverage from kcov
- A few things you should know before we begin:
    - This tutorial will likely only work for x86 and x86_64 Linux
        - this is enough for running on things like Travis, but you may need to take extra steps if you want to run code coverage locally
    - kcov not a Rust-specific code coverage tool, it uses DWARF debugging
      information to figure out which lines have run
    - kcov does not always generate entirely accurate code coverage: http://stackoverflow.com/questions/32521800/why-does-kcov-calculate-incorrect-code-coverage-statistics-for-rust-programs
    - As of writing this guide, there is no way to generate code coverage data for Rust doctests. The executable is only created temporarily while it is being run. If you find a way to collect doctest coverage, please open an [Issue][website-issues] and let me know.
- Old versions of kcov, including most packaged versions will not work with
  a Rust executable.
- We need to compile it manually
- (Detailed kcov compilation instructions)
- You can see an HTML coverage report by opening `foo/bar/index.html`
- The `--verify` flag does BLAH and without it you may get FOO error message
- Travis CI instructions
    - These instructions are specific to Travis CI, but should be ubiquitous enough to translate to any CI provider
    - To integrate with Travis CI, we essentially need to take the above instructions and translate them into a Travis CI configuration
    - Some caveats: since Travis CI trashes all files between builds, it is useful to use the Travis CI cache option to significantly speed up the build
    - Tests run twice, once in the build and once for coverage -- this can be fixed
- Integrating Codecov is as easy as running the codecov.io bash script at the end of your build after success: (example + full Travis CI)
    - It is important to run each test executable individually
    - You should tweak this if necessary based on your current setup
    - This should work out-of-the-box for most projects setup with cargo
    - This will upload the cobertura.xml files generated by kcov automatically
- Coveralls integration is built in to kcov
    - Show how to use the coveralls id option (or whatever it is called) with kcov
- If you have any questions, please don't hesitate to contact me (link to contact) or create an issue (link to website issues) for any problems or typos in this article


[old-tutorial]: https://users.rust-lang.org/t/tutorial-how-to-collect-test-coverages-for-rust-project/650
[contact]: /contact
[rust-irc]: https://www.rust-lang.org/community.html#irc-channels
[website-source]: https://github.com/sunjay/sunjay.github.io
[website-issues]: https://github.com/sunjay/sunjay.github.io/issues
[codecov]: https://codecov.io/
[codecov-rust-pr]: https://github.com/codecov/example-rust/pull/1
[codecov-example-rust]: https://github.com/codecov/example-rust
[coveralls]: https://coveralls.io/

